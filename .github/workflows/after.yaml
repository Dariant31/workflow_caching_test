name: ðŸŸ¢ Optimized CI (The Winner)
on: [push]

jobs:
  # This job just ensures the npm cache is ready
  warm-up:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm' # Use the built-in optimized cache
      - run: npm ci

  run-tests-parallel:
    needs: warm-up
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Fanning out into 5 parallel runners
        project: [api-1, api-2, api-3, api-4, api-5]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
      - run: npm ci # This will now be a 10-second "hit"

      - name: Run Parallel Test
        run: |
          PROJECTS="${{ matrix.project }}" \
          docker compose -f docker/docker-compose.poc.yml run run-poc-tests
